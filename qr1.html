<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Code Semua Tamu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    /* Menambahkan sedikit padding pada body dan font yang lebih halus */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      padding: 1rem;
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50">

  <header class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800">QR Code Undangan Tamu</h1>
    <p class="text-gray-500 mt-1">Hasilkan dan unduh QR code untuk setiap tamu.</p>
  </header>

  <div id="app-container" class="max-w-7xl mx-auto">
    <div id="loading-indicator" class="text-center w-full py-10">
      <p class="text-lg text-gray-600 animate-pulse">Memuat data tamu, mohon tunggu...</p>
    </div>

    <div id="qr-container" class="flex flex-wrap -m-2">
      </div>
  </div>

  <footer class="mt-12 text-center text-sm text-gray-500">
    <p>Partner with <a href="https://siskahandiska.com/" class="text-blue-600 font-semibold hover:underline" target="_blank">Siska Handiska Creative</a></p>
  </footer>

  <script>
    // Konfigurasi Aplikasi
    const config = {
      frameImageUrl: 'https://lh3.googleusercontent.com/d/1hGBGJidhSIYonvw_tJe1v72AgoimOV__=w1000',
      firebaseDataUrl: "https://harikebaya-2025-default-rtdb.firebaseio.com/guests.json",
      framePadding: 85, // Jarak QR code dari tepi bingkai
    };

    // Elemen DOM
    const qrContainer = document.getElementById("qr-container");
    const loadingIndicator = document.getElementById("loading-indicator");

    // Fungsi untuk menampilkan pesan error
    const showError = (message) => {
      loadingIndicator.style.display = 'none'; // Sembunyikan loader
      qrContainer.innerHTML = `<p class="text-red-500 font-semibold text-center w-full bg-red-50 p-4 rounded-lg">${message}</p>`;
    };
    
    // Inisialisasi gambar bingkai
    const frameImage = new Image();
    frameImage.src = config.frameImageUrl;
    frameImage.crossOrigin = "Anonymous";

    // Event handler ketika bingkai berhasil dimuat
    frameImage.onload = function() {
      fetchDataAndGenerateQRCodes();
    };

    // Event handler ketika bingkai gagal dimuat
    frameImage.onerror = function() {
      showError("âŒ Gagal memuat gambar bingkai. Periksa kembali URL gambar pada kode dan pastikan gambar dapat diakses.");
    };

    // Fungsi untuk mengambil data dan membuat QR code
    function fetchDataAndGenerateQRCodes() {
      fetch(config.firebaseDataUrl)
        .then(res => {
          if (!res.ok) {
            throw new Error(`Gagal mengambil data (Status: ${res.status})`);
          }
          return res.json();
        })
        .then(data => {
          loadingIndicator.style.display = 'none'; // Sembunyikan loader setelah data diterima

          if (!data || Object.keys(data).length === 0) {
            showError("Tidak ada data tamu yang ditemukan di database.");
            return;
          }

          Object.entries(data).forEach(([id, guest]) => {
            if (guest && guest.name) {
              createGuestCard(guest);
            }
          });
        })
        .catch(error => {
          console.error("Fetch Error:", error);
          showError(`Terjadi kesalahan saat mengambil data tamu: ${error.message}`);
        });
    }

    // Fungsi untuk membuat satu kartu tamu
    function createGuestCard(guest) {
      // 1. Buat elemen pembungkus untuk grid
      const wrapperDiv = document.createElement("div");
      wrapperDiv.className = "w-1/2 sm:w-1/3 md:w-1/4 lg:w-1/5 p-2";

      // 2. Buat elemen kartu
      const cardDiv = document.createElement("div");
      cardDiv.className = "bg-white p-4 rounded-xl shadow-lg text-center flex flex-col items-center h-full transition-shadow hover:shadow-2xl";

      // 3. Buat kanvas final untuk menggabungkan bingkai dan QR
      const finalCanvas = document.createElement("canvas");
      finalCanvas.width = frameImage.width;
      finalCanvas.height = frameImage.height;
      finalCanvas.className = "w-full h-auto rounded-md"; // Responsif
      const ctx = finalCanvas.getContext("2d");

      // 4. Hitung ukuran QR code agar pas di dalam padding bingkai
      const availableSize = frameImage.width - (config.framePadding * 2);
      const qrSize = Math.max(60, availableSize); // Pastikan ukuran tidak terlalu kecil

      // 5. Buat kanvas sementara untuk QR code saja
      const qrCanvas = document.createElement("canvas");
      const qrOptions = {
        width: qrSize,
        errorCorrectionLevel: 'H',
        margin: 1, // Margin kecil di dalam QR code
      };
      
      QRCode.toCanvas(qrCanvas, guest.name, qrOptions, function (error) {
        if (error) {
          console.error(`Gagal membuat QR untuk ${guest.name}:`, error);
          // Lewati tamu ini jika QR gagal dibuat
          return;
        }

        // --- INI BAGIAN PENTING YANG DIPERBAIKI ---
        // Gambar BINGKAI terlebih dahulu ke kanvas final
        ctx.drawImage(frameImage, 0, 0, finalCanvas.width, finalCanvas.height);
        
        // Hitung posisi tengah untuk menempatkan QR code
        const qrX = (finalCanvas.width - qrSize) / 2;
        const qrY = (finalCanvas.height - qrSize) / 2;

        // Gambar QR CODE di atas bingkai
        ctx.drawImage(qrCanvas, qrX, qrY);
        // ---------------------------------------------
        
        // 6. Tambahkan kanvas final ke dalam kartu
        cardDiv.appendChild(finalCanvas);

        // 7. Tambahkan nama tamu
        const nameElement = document.createElement("p");
        nameElement.className = "mt-4 font-bold text-lg text-gray-800 break-words w-full";
        nameElement.textContent = guest.name;
        cardDiv.appendChild(nameElement);

        // 8. Tambahkan tombol unduh
        const downloadBtn = document.createElement("a");
        downloadBtn.textContent = "Download QR";
        downloadBtn.className = "mt-4 w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300";
        downloadBtn.href = finalCanvas.toDataURL("image/png");
        downloadBtn.download = `QR-${guest.name.replace(/\s+/g, '_')}.png`; // Ganti spasi dengan underscore untuk nama file
        cardDiv.appendChild(downloadBtn);
        
        // 9. Gabungkan semua elemen dan tambahkan ke kontainer utama
        wrapperDiv.appendChild(cardDiv);
        qrContainer.appendChild(wrapperDiv);
      });
    }
  </script>

</body>
</html>
