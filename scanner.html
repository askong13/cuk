<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scanner Manual - Hari Kebaya</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

  <header class="bg-white shadow p-4 text-center font-bold text-xl">
    QR Scanner Manual - Hari Kebaya
  </header>

  <main class="flex-grow p-6 flex flex-col items-center space-y-4">
    <div id="reader" style="width: 300px;"></div>

    <div id="result" class="text-center mt-4 space-y-2">
      <!-- Data hasil scan akan ditampilkan di sini -->
    </div>

    <button id="checkinBtn" class="hidden bg-green-600 text-white px-4 py-2 rounded font-semibold">
      ✅ Konfirmasi Check-in
    </button>
  </main>

  <footer class="bg-white p-4 text-center text-sm text-gray-500">
    Partner with <a href="https://siskahandiska.com/" class="text-blue-600 font-semibold" target="_blank">Siska Handiska Creative</a>
  </footer>

  <script>
    const resultDiv = document.getElementById("result");
    const checkinBtn = document.getElementById("checkinBtn");
    let currentGuest = null;
    let currentId = null;

    function onScanSuccess(decodedText) {
      resultDiv.innerHTML = "Memuat data...";
      currentGuest = null;
      currentId = null;
      checkinBtn.classList.add("hidden");

      fetch("https://harikebaya-2025-default-rtdb.firebaseio.com/guests.json")
        .then(res => res.json())
        .then(data => {
          for (const [id, guest] of Object.entries(data || {})) {
            if (guest.name === decodedText) {
              currentGuest = guest;
              currentId = id;
              break;
            }
          }

          if (currentGuest) {
            const checked = currentGuest.checkedIn ? "✅ Sudah check-in" : "❌ Belum check-in";
            const time = currentGuest.checkinTime ? new Date(currentGuest.checkinTime).toLocaleString("id-ID") : "-";

            resultDiv.innerHTML = `
              <p><strong>Nama:</strong> ${currentGuest.name}</p>
              <p><strong>Status:</strong> ${checked}</p>
              <p><strong>Jam Check-in:</strong> ${time}</p>
            `;

            if (!currentGuest.checkedIn) {
              checkinBtn.classList.remove("hidden");
            }
          } else {
            resultDiv.innerHTML = `<span class="text-red-600">❌ Tamu tidak ditemukan: ${decodedText}</span>`;
          }
        });
    }

    checkinBtn.addEventListener("click", () => {
      if (!currentId) return;

      const now = new Date().toISOString();
      fetch(`https://harikebaya-2025-default-rtdb.firebaseio.com/guests/${currentId}.json`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ checkedIn: true, checkinTime: now })
      }).then(() => {
        resultDiv.innerHTML += `<p class="text-green-600 font-semibold mt-2">✅ Berhasil check-in!</p>`;
        checkinBtn.classList.add("hidden");
      });
    });

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
      fps: 10,
      qrbox: 250,
      rememberLastUsedCamera: true,
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    }, false); // false = manual, bukan auto-checkin

    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>