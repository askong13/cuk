<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Scanner - Hari Kebaya 2025</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    /* Mengaplikasikan font Poppins sebagai default */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #FFC236;
    }
    /* Kustomisasi border area scan */
    #reader__scan_region {
        border-radius: 0.75rem; /* rounded-xl */
        border: 4px dashed rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body class="text-gray-800 flex flex-col min-h-screen items-center justify-center p-4">

  <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 md:p-8 space-y-6 transform transition-all">
    
    <div class="text-center space-y-4">
      <img src="https://via.placeholder.com/150/F3F4F6/374151?text=Ganti+Logo" alt="Logo Acara" class="mx-auto h-24 w-24 rounded-full border-4 border-gray-800 shadow-lg">
      <h1 class="text-2xl font-bold text-gray-900 tracking-wide">Scanner Hari Kebaya</h1>
      <p class="text-sm text-gray-500">Arahkan kamera ke QR Code tamu</p>
    </div>

    <div id="reader" class="w-full h-auto rounded-xl overflow-hidden bg-gray-100"></div>

    <div id="result" class="text-center min-h-[120px] flex items-center justify-center p-4 bg-gray-100 rounded-lg">
      <span class="text-gray-500">Arahkan kamera untuk memulai</span>
    </div>

    <div class="space-y-3">
        <button id="checkinBtn" class="hidden w-full bg-gray-800 text-white px-6 py-3 rounded-lg font-bold text-lg transition-all duration-300 ease-in-out hover:bg-gray-700 transform hover:scale-105">
        ‚úÖ Konfirmasi Check-in
        </button>
        <button id="rescanBtn" class="hidden w-full bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 ease-in-out hover:bg-gray-500">
        üîÑ Pindai Lagi
        </button>
    </div>
  </div>
  
  <footer class="absolute bottom-4 text-center text-sm text-gray-800/80">
    Partner with <a href="https://siskahandiska.com/" class="font-semibold hover:underline" target="_blank">Siska Handiska Creative</a>
  </footer>

  <script>
    const resultDiv = document.getElementById("result");
    const checkinBtn = document.getElementById("checkinBtn");
    const rescanBtn = document.getElementById("rescanBtn");
    const readerDiv = document.getElementById("reader");

    let currentGuest = null;
    let currentId = null;

    // Spinner untuk loading
    const loadingSpinner = `
      <div class="flex flex-col items-center justify-center space-y-2">
        <svg class="animate-spin h-8 w-8 text-gray-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-gray-500">Mencari data tamu...</span>
      </div>`;

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
      fps: 10,
      qrbox: (w, h) => ({ width: w * 0.8, height: w * 0.8 }),
      rememberLastUsedCamera: true,
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    }, false); 

    function onScanSuccess(decodedText) {
      // 1. Langsung hentikan scanner agar tidak memindai terus-menerus
      html5QrcodeScanner.pause(true); // 'true' = pause decoding but keep camera on
      
      resultDiv.innerHTML = loadingSpinner;
      currentGuest = null;
      currentId = null;
      checkinBtn.classList.add("hidden");

      fetch("https://harikebaya-2025-default-rtdb.firebaseio.com/guests.json")
        .then(res => res.ok ? res.json() : Promise.reject('Gagal mengambil data'))
        .then(data => {
          for (const [id, guest] of Object.entries(data || {})) {
            if (guest.name === decodedText) {
              currentGuest = guest;
              currentId = id;
              break;
            }
          }

          if (currentGuest) {
            const statusClass = currentGuest.checkedIn ? "text-green-600" : "text-blue-600";
            const statusText = currentGuest.checkedIn ? "‚úÖ Sudah Check-in" : "‚ùå Belum Check-in";
            const time = currentGuest.checkinTime ? new Date(currentGuest.checkinTime).toLocaleString("id-ID", { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "-";

            resultDiv.innerHTML = `
              <div class="space-y-2 text-left w-full">
                  <p class="text-lg"><strong>Nama:</strong> <span class="font-semibold text-gray-900">${currentGuest.name}</span></p>
                  <p><strong>Status:</strong> <span class="font-bold ${statusClass}">${statusText}</span></p>
                  <p><strong>Waktu:</strong> <span class="text-gray-600">${time}</span></p>
              </div>
            `;

            if (!currentGuest.checkedIn) {
              checkinBtn.classList.remove("hidden");
            }
          } else {
            resultDiv.innerHTML = `<span class="text-red-600 font-bold">üö´ Tamu tidak ditemukan: ${decodedText}</span>`;
          }

          // 2. Tampilkan tombol "Pindai Lagi" setelah hasil muncul
          rescanBtn.classList.remove("hidden");
        })
        .catch(error => {
          console.error("Fetch error:", error);
          resultDiv.innerHTML = `<span class="text-red-600 font-bold">‚ö†Ô∏è Terjadi kesalahan jaringan. Coba lagi.</span>`;
          rescanBtn.classList.remove("hidden"); // Tampilkan juga jika error
        });
    }

    checkinBtn.addEventListener("click", () => {
      if (!currentId) return;

      checkinBtn.disabled = true;
      checkinBtn.innerText = "Memproses...";

      const now = new Date().toISOString();
      fetch(`https://harikebaya-2025-default-rtdb.firebaseio.com/guests/${currentId}.json`, {
        method: "PATCH",
        body: JSON.stringify({ checkedIn: true, checkinTime: now })
      })
      .then(res => res.json())
      .then(updatedGuest => {
        const time = new Date(updatedGuest.checkinTime).toLocaleString("id-ID", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        resultDiv.innerHTML = `
            <div class="space-y-2 text-left w-full">
                <p class="text-lg"><strong>Nama:</strong> <span class="font-semibold text-gray-900">${updatedGuest.name}</span></p>
                <p><strong>Status:</strong> <span class="font-bold text-green-600">‚úÖ Berhasil Check-in!</span></p>
                <p><strong>Waktu:</strong> <span class="text-gray-600">${time}</span></p>
            </div>
        `;
        checkinBtn.classList.add("hidden"); // Sembunyikan tombol checkin setelah berhasil
      })
      .catch(error => {
        resultDiv.innerHTML += `<p class="text-red-600 font-semibold mt-2">Gagal check-in. Coba lagi.</p>`;
      })
      .finally(() => {
        checkinBtn.disabled = false;
        checkinBtn.innerHTML = `‚úÖ Konfirmasi Check-in`;
      });
    });

    // 3. Event listener untuk tombol "Pindai Lagi"
    rescanBtn.addEventListener("click", () => {
        resultDiv.innerHTML = `<span class="text-gray-500">Arahkan kamera untuk memulai</span>`;
        rescanBtn.classList.add("hidden");
        checkinBtn.classList.add("hidden");

        // Pastikan kamera tidak error sebelum melanjutkan
        if (html5QrcodeScanner.getState() === Html5QrcodeScannerState.PAUSED) {
            html5QrcodeScanner.resume();
        }
    });

    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>
