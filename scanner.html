<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Scanner - Hari Kebaya 2025</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #FFC236;
    }
    #reader__scan_region {
      border-radius: 0.75rem;
      border: 4px dashed rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body class="text-gray-800 flex flex-col min-h-screen items-center justify-center p-4">

  <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
    <div class="text-center space-y-2">
      <h1 class="text-2xl font-bold text-gray-900 tracking-wide">Scanner Hari Kebaya</h1>
      <p class="text-sm text-gray-500">Arahkan kamera ke QR Code tamu</p>
    </div>
    <div id="reader" class="w-full h-auto rounded-xl overflow-hidden bg-gray-100"></div>
    <div class="text-center text-gray-500 pt-2">
        Menunggu pemindaian...
    </div>
  </div>

  <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div id="modalContent" class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 space-y-5 transform transition-all scale-95 opacity-0">
      
      <div class="text-center space-y-3">
        <img src="https://via.placeholder.com/150/FBBF24/374151?text=Ganti+Logo" alt="Logo Acara" class="mx-auto h-20 w-20 rounded-full border-4 border-[#FFC236] shadow-lg">
        <h2 class="text-xl font-bold text-gray-800">Detail Tamu</h2>
      </div>

      <div id="guestInfo" class="space-y-2 border-t border-b border-gray-200 py-4">
          </div>
      
      <div class="flex flex-col sm:flex-row gap-3">
        <button id="modalCheckinBtn" class="hidden w-full bg-[#FFC236] text-gray-900 px-5 py-3 rounded-lg font-bold transition hover:bg-yellow-500">
          ‚úÖ Konfirmasi Check-in
        </button>
        <button id="modalRescanBtn" class="w-full bg-gray-200 text-gray-700 px-5 py-3 rounded-lg font-semibold transition hover:bg-gray-300">
          Tutup & Pindai Lagi
        </button>
      </div>

    </div>
  </div>
  
  <footer class="absolute bottom-4 text-center text-sm text-gray-800/80">
    Partner with <a href="https://siskahandiska.com/" class="font-semibold hover:underline" target="_blank">Siska Handiska Creative</a>
  </footer>

  <script>
    // Elemen Modal
    const modalOverlay = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const guestInfoDiv = document.getElementById('guestInfo');
    const modalCheckinBtn = document.getElementById('modalCheckinBtn');
    const modalRescanBtn = document.getElementById('modalRescanBtn');

    let currentGuest = null;
    let currentId = null;

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
      fps: 10,
      qrbox: (w, h) => ({ width: w * 0.8, height: w * 0.8 }),
      rememberLastUsedCamera: true
    }, false);

    function showModal() {
        modalOverlay.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
        }, 10); // delay kecil untuk memulai transisi
    }

    function hideModal() {
        modalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalOverlay.classList.add('hidden');
            // Lanjutkan pemindaian setelah modal tertutup
            if (html5QrcodeScanner.getState() === Html5QrcodeScannerState.PAUSED) {
                html5QrcodeScanner.resume();
            }
        }, 200); // Sesuaikan dengan durasi transisi
    }
    
    // Event listener untuk menutup modal
    modalRescanBtn.addEventListener('click', hideModal);

    function onScanSuccess(decodedText) {
      html5QrcodeScanner.pause(true); // Jeda pemindai
      
      guestInfoDiv.innerHTML = `<p class="text-center text-gray-500">Mencari data...</p>`;
      modalCheckinBtn.classList.add('hidden');
      showModal();

      fetch("https://harikebaya-2025-default-rtdb.firebaseio.com/guests.json")
        .then(res => res.ok ? res.json() : Promise.reject('Gagal mengambil data'))
        .then(data => {
          for (const [id, guest] of Object.entries(data || {})) {
            if (guest.name === decodedText) {
              currentGuest = guest;
              currentId = id;
              break;
            }
          }

          if (currentGuest) {
            const statusClass = currentGuest.checkedIn ? "text-green-600" : "text-blue-600";
            const statusText = currentGuest.checkedIn ? "‚úÖ Sudah Check-in" : "‚ùå Belum Check-in";
            const time = currentGuest.checkinTime ? new Date(currentGuest.checkinTime).toLocaleString("id-ID", { hour: '2-digit', minute: '2-digit' }) : "-";

            guestInfoDiv.innerHTML = `
              <p><strong>Nama:</strong> <span class="font-semibold text-gray-900">${currentGuest.name}</span></p>
              <p><strong>Status:</strong> <span class="font-bold ${statusClass}">${statusText}</span></p>
              <p><strong>Waktu:</strong> <span class="text-gray-600">${time}</span></p>
            `;
            if (!currentGuest.checkedIn) {
              modalCheckinBtn.classList.remove('hidden');
            }
          } else {
            guestInfoDiv.innerHTML = `<p class="text-center text-red-600 font-bold">üö´ Tamu tidak ditemukan: ${decodedText}</p>`;
          }
        })
        .catch(error => {
          guestInfoDiv.innerHTML = `<p class="text-center text-red-600 font-bold">‚ö†Ô∏è Terjadi kesalahan jaringan.</p>`;
        });
    }
    
    modalCheckinBtn.addEventListener('click', () => {
      if (!currentId) return;

      modalCheckinBtn.disabled = true;
      modalCheckinBtn.innerText = "Memproses...";

      fetch(`https://harikebaya-2025-default-rtdb.firebaseio.com/guests/${currentId}.json`, {
        method: "PATCH",
        body: JSON.stringify({ checkedIn: true, checkinTime: new Date().toISOString() })
      })
      .then(res => res.json())
      .then(updatedGuest => {
        const time = new Date(updatedGuest.checkinTime).toLocaleString("id-ID", { hour: '2-digit', minute: '2-digit' });
        guestInfoDiv.innerHTML = `
            <p><strong>Nama:</strong> <span class="font-semibold text-gray-900">${updatedGuest.name}</span></p>
            <p class="font-bold text-green-600 text-lg">‚úÖ Berhasil Check-in!</p>
            <p><strong>Waktu:</strong> <span class="text-gray-600">${time}</span></p>
        `;
        modalCheckinBtn.classList.add('hidden'); // Sembunyikan tombol setelah berhasil
      })
      .catch(error => {
         guestInfoDiv.innerHTML += `<p class="text-red-500 font-semibold mt-2">Gagal check-in.</p>`;
      })
      .finally(() => {
        modalCheckinBtn.disabled = false;
        modalCheckinBtn.innerHTML = `‚úÖ Konfirmasi Check-in`;
      });
    });

    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
</html>
